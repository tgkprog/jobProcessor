#!/bin/bash

# Build and Run Script for Job Processor
# Author: Tushar Kapila

APP_PROPS="src/main/resources/application.properties"
VER_DATE="src/main/resources/verDate.txt"
JAR_FAT="target/jobProc-1.0.0-fat.jar"
JAR_SLIM="target/jobProc-1.0.0.jar"
BIN_DIR="bin"
BIN_JAR_FAT="$BIN_DIR/jobProc-fat.jar"
BIN_JAR_SLIM="$BIN_DIR/jobProc.jar"
MAIN_CLASS="com.sel2in.jobProc.JobProcApp"



usage() {
    echo "Usage: ./build [params]"
    echo "Params:"
    echo "  c    : mvn clean"
    echo "  p    : mvn install and copy to bin"
    echo "  rf   : stop old, run fat jar from bin"
    echo "  rs   : stop old, run slim jar from bin"
    echo "  ver  : print usage and version and exit"
    echo "  ver1 : increase patch version (x.y.Z)"
    echo "  ver2 : increase minor version (x.Y.z)"
    echo "  ver3 : increase major version (X.y.z)"
    echo "  logDel: clean logs older than 20 days"
}

compile_util() {
    mkdir -p "$BIN_DIR"
    if [ -f "../misc/LogCleaner.java" ]; then
        javac -d "$BIN_DIR" ../misc/LogCleaner.java
    fi
}

log_del() {
    compile_util
    if [ -d "logs" ]; then
        java -cp "$BIN_DIR" LogCleaner logs 20
    fi
}

get_version() {
    if [ -f "$APP_PROPS" ]; then
        grep "app.version=" "$APP_PROPS" | cut -d'=' -f2
    else
        echo "1.0.0"
    fi
}

update_version() {
    local index=$1
    local current_ver=$(get_version)
    IFS='.' read -r -a parts <<< "$current_ver"
    
    # Fill defaults if missing
    for i in 0 1 2; do
        if [ -z "${parts[$i]}" ]; then parts[$i]=0; fi
    done

    ((parts[$index]++))
    
    # Reset lower parts for semantic versioning
    if [ "$index" -eq 0 ]; then
        parts[1]=0
        parts[2]=0
    elif [ "$index" -eq 1 ]; then
        parts[2]=0
    fi

    local new_ver="${parts[0]}.${parts[1]}.${parts[2]}"
    
    if [ ! -f "$APP_PROPS" ]; then
        echo "app.version=$new_ver" > "$APP_PROPS"
    else
        if grep -q "app.version=" "$APP_PROPS"; then
            sed -i "s/app.version=.*/app.version=$new_ver/" "$APP_PROPS"
        else
            echo "app.version=$new_ver" >> "$APP_PROPS"
        fi
    fi
    echo "Updated version in $APP_PROPS to: $new_ver"
}

prepare_resources() {
    # Ensure resources directory exists
    mkdir -p src/main/resources
    # Requirement: set the verDate.txt with current date, time and time zone
    date +"%Y-%m-%d %H:%M:%S %Z" > "$VER_DATE"
    echo "Updated $VER_DATE"
    log_del
}

if [ $# -eq 0 ]; then
    usage
    exit 0
fi

for arg in "$@"; do
    case $arg in
        c)
            prepare_resources
            echo "Running mvn clean..."
            mvn clean
            ;;
        p)
            prepare_resources
            echo "Running mvn install..."
            if mvn install; then
                mkdir -p "$BIN_DIR"
                cp "$JAR_FAT" "$BIN_JAR_FAT"
                cp "$JAR_SLIM" "$BIN_JAR_SLIM"
                echo "Copied to bin/"
            else
                echo "Build failed!"
                exit 1
            fi
            ;;
        rf)
            if [ -f "./kil" ]; then
                echo "Stopping old instances..."
                ./kil
            fi
            echo "Running fat jar from bin..."
            if [ -f "$BIN_JAR_FAT" ]; then
                java -jar "$BIN_JAR_FAT"
            else
                echo "Error: $BIN_JAR_FAT not found. Run 'p' first."
            fi
            ;;
        rs)
            if [ -f "./kil" ]; then
                echo "Stopping old instances..."
                ./kil
            fi
            echo "Running slim jar from bin..."
            if [ -f "$BIN_JAR_SLIM" ]; then
                java -cp "$BIN_JAR_SLIM:target/lib/*" "$MAIN_CLASS"
            else
                echo "Error: $BIN_JAR_SLIM not found. Run 'p' first."
            fi
            ;;
        ver)
            usage
            if [ -f "$VER_DATE" ]; then
                echo "Last Build: $(cat "$VER_DATE")"
            else
                echo "Last Build: No build record found."
            fi
            echo "Project Version: $(get_version)"
            exit 0
            ;;
        ver1)
            update_version 2
            ;;
        ver2)
            update_version 1
            ;;
        ver3)
            update_version 0
            ;;
        logDel)
            log_del
            ;;
        *)
            echo "Unknown parameter: $arg"
            usage
            ;;
    esac
done