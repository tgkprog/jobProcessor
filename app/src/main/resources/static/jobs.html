<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Job Tracking & Scheduling - Job Processor</title>
    <link rel="stylesheet" href="res/main.css">
    <script src="res/header.js"></script>
</head>

<body>

    <div class="container">
        <h1>Job Tracking & Scheduling</h1>

        <div class="section">
            <h2>Schedule New Job</h2>
            <form id="scheduleJobForm">
                <div class="form-group">
                    <label for="processorClassName">Processor Class</label>
                    <input type="text" id="processorClassName" name="processorClassName"
                        placeholder="e.g., com.sel2in.jobProc.processors.DateFileTxn" required>
                </div>
                <div class="form-group">
                    <label for="jobName">Job Name</label>
                    <input type="text" id="jobName" name="jobName" placeholder="e.g., Monthly Audit" required>
                </div>
                <div class="form-group">
                    <label for="comment">Comment</label>
                    <input type="text" id="comment" name="comment" placeholder="Optional notes">
                </div>
                <div class="form-group">
                    <label for="inputFiles">Input Files</label>
                    <input type="file" id="inputFiles" name="files" multiple>
                    <p class="hint">Upload one or more files for the processor.</p>
                </div>

                <label>Earliest Run Time (delay from now)</label>
                <div class="delay-row">
                    <div class="form-group">
                        <label for="delayDays">Days</label>
                        <input type="number" id="delayDays" name="delayDays" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label for="delayHours">Hours</label>
                        <input type="number" id="delayHours" name="delayHours" value="0" min="0" max="23">
                    </div>
                    <div class="form-group">
                        <label for="delayMinutes">Minutes</label>
                        <input type="number" id="delayMinutes" name="delayMinutes" value="1" min="0" max="59">
                    </div>
                </div>
                <p class="hint">Minimum delay is 30 seconds. Default: 1 minute.</p>

                <button type="button" onclick="submitJob()">Schedule Job</button>
            </form>
        </div>

        <div class="section">
            <h2>Jobs</h2>
            <table id="jobsStatusTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Processor</th>
                        <th>Submitted</th>
                        <th>Scheduled For</th>
                        <th>Started</th>
                        <th>Ended</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = "/api/job";

        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const processor = urlParams.get('processor');
            if (processor) {
                document.getElementById('processorClassName').value = processor;
                document.getElementById('jobName').value = "Run " + processor.split('.').pop();
            }
            refreshJobTable();
        };

        function submitJob() {
            const formData = new FormData();
            formData.append('jobName', document.getElementById('jobName').value);
            formData.append('processorClassName', document.getElementById('processorClassName').value);
            formData.append('comment', document.getElementById('comment').value);
            formData.append('delayDays', document.getElementById('delayDays').value);
            formData.append('delayHours', document.getElementById('delayHours').value);
            formData.append('delayMinutes', document.getElementById('delayMinutes').value);

            const fileInput = document.getElementById('inputFiles');
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append('files', fileInput.files[i]);
            }

            fetch(API_BASE + "/schedule", {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    alert("Job Scheduled!\nID: " + data.id + "\nRuns at: " + formatDateTime(data.scheduledRunTime));
                    refreshJobTable();
                    document.getElementById('scheduleJobForm').reset();
                })
                .catch(err => alert("Error scheduling job: " + err));
        }

        function runNow(jobId) {
            fetch(API_BASE + "/run?jobId=" + jobId)
                .then(res => res.text())
                .then(msg => {
                    alert(msg);
                    setTimeout(refreshJobTable, 1000);
                });
        }

        function formatDateTime(dt) {
            if (!dt) return "-";
            return dt.replace("T", " ").substring(0, 19);
        }

        function cancelJob(jobId) {
            if (!confirm("Are you sure you want to cancel job " + jobId + "?")) return;
            fetch("/api/admin/job/cancel?jobId=" + jobId, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.cancelled) {
                        alert("Job " + jobId + " cancelled.");
                    } else {
                        alert("Could not cancel job " + jobId + ". It might have finished already.");
                    }
                    refreshJobTable();
                });
        }

        function refreshJobTable() {
            fetch(API_BASE + "/status")
                .then(res => res.json())
                .then(data => {
                    const tbody = document.querySelector("#jobsStatusTable tbody");
                    tbody.innerHTML = "";
                    data.sort((a, b) => b.id - a.id); // Show newest first
                    data.forEach(job => {
                        const row = tbody.insertRow();
                        row.insertCell(0).innerText = job.id;
                        row.insertCell(1).innerText = job.jobName;
                        row.insertCell(2).innerText = (job.processorClassName || "").split('.').pop();
                        row.insertCell(3).innerText = formatDateTime(job.jobSubmittedDateTime);
                        row.insertCell(4).innerText = formatDateTime(job.scheduledRunTime);
                        row.insertCell(5).innerText = formatDateTime(job.jobStartDateTime);
                        row.insertCell(6).innerText = formatDateTime(job.jobEndDateTime);

                        const statusCell = row.insertCell(7);
                        statusCell.innerHTML = '<span class="status-' + job.status + '">' + job.status + '</span>';

                        const actionsCell = row.insertCell(8);
                        let actionsHtml = '';
                        if (job.status === 'SCHEDULED' || job.status === 'FAILED') {
                            let canRunNow = true;
                            if (job.status === 'SCHEDULED' && job.scheduledRunTime) {
                                // Server time might differ, but local check is a good UX guide
                                const scheduledTime = new Date(job.scheduledRunTime).getTime();
                                const now = new Date().getTime();
                                const diffSec = (scheduledTime - now) / 1000;
                                if (diffSec < 20) canRunNow = false;
                            }

                            if (canRunNow) {
                                actionsHtml += '<button class="btn-small btn-run" onclick="runNow(' + job.id + ')">Run Now</button> ';
                            } else {
                                actionsHtml += '<span class="hint">Starting soon...</span> ';
                            }
                        }
                        if (job.status === 'RUNNING' || job.status === 'SCHEDULED') {
                            actionsHtml += '<button class="btn-small btn-danger" onclick="cancelJob(' + job.id + ')">Cancel</button>';
                        }
                        actionsCell.innerHTML = actionsHtml;
                    });
                });
        }

        setInterval(refreshJobTable, 5000);
    </script>

</body>

</html>