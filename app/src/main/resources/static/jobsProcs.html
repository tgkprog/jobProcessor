<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Job Processor Control Panel</title>
    <link rel="stylesheet" href="res/main.css">
    <script src="res/header.js"></script>
</head>

<body>
    <div class="container">
        <h1>Job Processor Control Panel</h1>

        <div class="section">
            <h2>Add / Update Job Processor</h2>
            <div class="form-row">
                <div style="flex:1">
                    <label>Class Name</label>
                    <input type="text" id="className" placeholder="com.sel2in.jobProc.processors.MyProcessor">
                    <input type="hidden" id="originalClassName" value="">
                </div>
                <div style="flex:1">
                    <label>Jar Path</label>
                    <input type="text" id="jarPath" placeholder="./processors/myproc.jar">
                </div>
                <button onclick="addOrUpdate()">Save</button>
                <button onclick="clearForm()" style="background:#64748b">Clear</button>
            </div>
        </div>

        <div class="section">
            <h2>Job Processor List</h2>
            <table id="jobTable">
                <thead>
                    <tr>
                        <th>Class Name</th>
                        <th>Jar Path</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = "/api/job";

        function loadJobs() {
            fetch(API_BASE + "/listAll")
                .then(res => res.json())
                .then(data => {
                    let table = document.querySelector("#jobTable tbody");
                    table.innerHTML = "";
                    data.forEach(job => {
                        let row = table.insertRow();
                        row.insertCell(0).innerText = job.className;
                        row.insertCell(1).innerText = job.jarPath;

                        let actions = row.insertCell(2);
                        actions.innerHTML = `
                            <button class="btn-small" onclick="editJob('${job.className}','${job.jarPath}')">Edit</button>
                            <button class="btn-small" onclick="scheduleJob('${job.className}')">Schedule</button>
                            <button class="btn-small btn-danger" onclick="deleteJob('${job.className}')">Delete</button>
                        `;
                    });
                });
        }

        function addOrUpdate() {
            let className = document.getElementById("className").value.trim();
            let jarPath = document.getElementById("jarPath").value.trim();
            let originalClassName = document.getElementById("originalClassName").value;

            // Validate className
            if (!className) {
                alert("Class Name cannot be empty");
                return;
            }
            if (className.includes('/') || className.includes('\\') || className.includes('..')) {
                alert("Class Name contains invalid characters (/, \\, ..)");
                return;
            }
            if (!jarPath) {
                alert("Jar Path cannot be empty");
                return;
            }

            // If editing and className changed, delete the old one first
            if (originalClassName && originalClassName !== className) {
                fetch(API_BASE + "/remove/" + encodeURIComponent(originalClassName), { method: "DELETE" })
                    .then(() => {
                        saveProcessor(className, jarPath);
                    })
                    .catch(err => {
                        alert("Error removing old processor: " + err);
                    });
            } else {
                saveProcessor(className, jarPath);
            }
        }

        function saveProcessor(className, jarPath) {
            fetch(API_BASE + "/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    className: className,
                    jarPath: jarPath
                })
            })
                .then(res => res.text())
                .then(msg => {
                    alert(msg);
                    clearForm();
                    loadJobs();
                })
                .catch(err => alert("Error: " + err));
        }

        function clearForm() {
            document.getElementById("className").value = "";
            document.getElementById("jarPath").value = "";
            document.getElementById("originalClassName").value = "";
        }

        function editJob(className, jarPath) {
            document.getElementById("className").value = className;
            document.getElementById("jarPath").value = jarPath;
            document.getElementById("originalClassName").value = className;
        }

        function scheduleJob(className) {
            window.location.href = `jobs.html?processor=${className}`;
        }

        function deleteJob(className) {
            if (!confirm("Delete processor?")) return;
            fetch(API_BASE + "/remove/" + className, { method: "DELETE" })
                .then(res => res.text())
                .then(msg => {
                    alert(msg);
                    loadJobs();
                });
        }

        loadJobs();
    </script>
</body>

</html>